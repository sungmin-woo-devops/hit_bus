{% extends "base.html" %}

{% block title %}ë²„ìŠ¤ ë…¸ì„  ì§€ë„ - MyWebsite{% endblock %}

{% block extra_css %}
<style>
    .map-container {
        width: 100%;
        height: 700px;
        margin: 20px 0;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        position: relative;
    }
    
    .map-info {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .map-controls {
        margin: 10px 0;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .map-controls button {
        padding: 8px 16px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    
    .map-controls button:hover {
        background-color: #f8f9fa;
    }
    
    .map-controls button.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .data-panel {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .data-panel h3 {
        margin-top: 0;
        color: #333;
    }
    
    .routes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }
    
    .route-card {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        border-left: 4px solid #007bff;
    }
    
    .route-card h5 {
        margin: 0 0 10px 0;
        color: #007bff;
    }
    
    .route-card p {
        margin: 5px 0;
        font-size: 14px;
    }
    
    .loading {
        text-align: center;
        padding: 50px;
        color: #666;
    }
    
    .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 6px;
        margin: 10px 0;
    }
    
    .success-message {
        background: #d4edda;
        color: #155724;
        padding: 15px;
        border-radius: 6px;
        margin: 10px 0;
    }
    
    .map-iframe {
        width: 100%;
        height: 100%;
        border: none;
    }
    
    .load-more-container {
        text-align: center;
        margin: 20px 0;
    }
    
    .load-more-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.2s ease;
    }
    
    .load-more-btn:hover {
        background: #0056b3;
    }
    
    .load-more-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }
    
    .routes-stats {
        background: #e9ecef;
        padding: 10px 15px;
        border-radius: 6px;
        margin-bottom: 15px;
        font-size: 14px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="map-info">
        <h2>ğŸšŒ Folium ë²„ìŠ¤ ë…¸ì„  ì§€ë„</h2>
        <p>ì´ í˜ì´ì§€ëŠ” Foliumì„ ì‚¬ìš©í•˜ì—¬ ë²„ìŠ¤ ë…¸ì„ ê³¼ ì •ê±°ì¥ ì •ë³´ë¥¼ ì‹œê°í™”í•©ë‹ˆë‹¤.</p>
        {% if error_message %}
        <div class="error-message">
            <strong>ì˜¤ë¥˜:</strong> {{ error_message }}
        </div>
        {% endif %}
    </div>
    
    <div class="map-controls">
        <button id="loadMap" class="active">ì§€ë„ ë¡œë“œ</button>
        <button id="regenerateMap">ì§€ë„ ì¬ìƒì„±</button>
        <button id="refreshRoutes">ë…¸ì„  ì •ë³´ ìƒˆë¡œê³ ì¹¨</button>
        <button id="downloadMap">ì§€ë„ ë‹¤ìš´ë¡œë“œ</button>
    </div>
    
    <div id="folium-map" class="map-container">
        {% if has_map %}
            <iframe id="map-iframe" class="map-iframe" src="/api/bus-map"></iframe>
        {% else %}
            <div class="loading">
                <h4>ì§€ë„ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...</h4>
                <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
            </div>
        {% endif %}
    </div>
    
    <div class="data-panel">
        <h3>ğŸ“Š ë…¸ì„  ì •ë³´</h3>
        <div id="routes-info">
            {% if routes_summary %}
                <div class="routes-stats">
                    <strong>ì´ ë…¸ì„  ìˆ˜:</strong> {{ routes_summary|length }}ê°œ | 
                    <span id="displayed-count">12</span>ê°œ í‘œì‹œ ì¤‘
                </div>
                <div id="routes-grid" class="routes-grid">
                    {% for route in routes_summary[:12] %}
                    <div class="route-card">
                        <h5>ë…¸ì„  {{ route.route_no }}ë²ˆ</h5>
                        <p><strong>ë…¸ì„  ID:</strong> {{ route.route_id }}</p>
                        <p><strong>ì •ê±°ì¥ ìˆ˜:</strong> {{ route.node_count }}ê°œ</p>
                    </div>
                    {% endfor %}
                </div>
                {% if routes_summary|length > 12 %}
                <div class="load-more-container">
                    <button id="load-more-routes" class="load-more-btn">
                        ë”ë³´ê¸° ({{ routes_summary|length - 12 }}ê°œ ë” ìˆìŒ)
                    </button>
                </div>
                {% endif %}
            {% else %}
                <p>ë…¸ì„  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if has_map %}
<script>window.pageData = {hasMap: true};</script>
{% else %}
<script>window.pageData = {hasMap: false};</script>
{% endif %}
<script>
    // ì „ì—­ ë³€ìˆ˜
    var allRoutes = [];
    var displayedRoutesCount = 12;
    var routesPerPage = 12;
    
    document.addEventListener('DOMContentLoaded', function() {
        setupEventListeners();
        setupLoadMoreListener();
        
        // ì´ˆê¸° ë…¸ì„  ë°ì´í„° ë¡œë“œ
        loadInitialRoutes();
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì§€ë„ê°€ ì—†ìœ¼ë©´ ìƒì„± ì‹œë„
        if (!window.pageData.hasMap) {
            setTimeout(function() {
                regenerateMap();
            }, 1000);
        }
    });
    
    function loadInitialRoutes() {
        // ì„œë²„ì—ì„œ ì „ë‹¬ëœ ì´ˆê¸° ë…¸ì„  ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
        fetch('/api/routes-summary')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allRoutes = data.routes;
                    console.log('ì´ˆê¸° ë…¸ì„  ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', allRoutes.length + 'ê°œ');
                }
            })
            .catch(error => {
                console.error('ì´ˆê¸° ë…¸ì„  ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
            });
    }
    
    function setupEventListeners() {
        // ì§€ë„ ë¡œë“œ ë²„íŠ¼
        document.getElementById('loadMap').addEventListener('click', function() {
            loadMap();
            updateButtonState(this);
        });
        
        // ì§€ë„ ì¬ìƒì„± ë²„íŠ¼
        document.getElementById('regenerateMap').addEventListener('click', function() {
            regenerateMap();
            updateButtonState(this);
        });
        
        // ë…¸ì„  ì •ë³´ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼
        document.getElementById('refreshRoutes').addEventListener('click', function() {
            refreshRoutesInfo();
            updateButtonState(this);
        });
        
        // ì§€ë„ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
        document.getElementById('downloadMap').addEventListener('click', function() {
            downloadMap();
            updateButtonState(this);
        });
    }
    
    function setupLoadMoreListener() {
        // DOMì´ ë³€ê²½ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì´ë²¤íŠ¸ ìœ„ì„ ì‚¬ìš©
        document.addEventListener('click', function(event) {
            if (event.target && event.target.id === 'load-more-routes') {
                event.preventDefault();
                loadMoreRoutes();
            }
        });
    }
    
    function loadMoreRoutes() {
        console.log('ë”ë³´ê¸° ë²„íŠ¼ í´ë¦­ë¨. í˜„ì¬ í‘œì‹œëœ ë…¸ì„ :', displayedRoutesCount, 'ì „ì²´ ë…¸ì„ :', allRoutes.length);
        
        if (allRoutes.length === 0) {
            showMessage('ë…¸ì„  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...', 'success');
            // ì „ì²´ ë…¸ì„  ë°ì´í„°ê°€ ì—†ìœ¼ë©´ APIì—ì„œ ê°€ì ¸ì˜¤ê¸°
            fetch('/api/routes-summary')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        allRoutes = data.routes;
                        console.log('APIì—ì„œ ë…¸ì„  ë°ì´í„° ë¡œë“œ:', allRoutes.length + 'ê°œ');
                        displayMoreRoutes();
                    } else {
                        showMessage('ë…¸ì„  ë°ì´í„° ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    }
                })
                .catch(error => {
                    console.error('ë…¸ì„  ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                    showMessage('ë…¸ì„  ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                });
        } else {
            displayMoreRoutes();
        }
    }
    
    function displayMoreRoutes() {
        var routesGrid = document.getElementById('routes-grid');
        var loadMoreBtn = document.getElementById('load-more-routes');
        var displayedCountSpan = document.getElementById('displayed-count');
        
        if (!routesGrid || !loadMoreBtn || !displayedCountSpan) {
            console.error('í•„ìš”í•œ DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        var nextCount = Math.min(displayedRoutesCount + routesPerPage, allRoutes.length);
        var routesToAdd = allRoutes.slice(displayedRoutesCount, nextCount);
        
        console.log('ì¶”ê°€í•  ë…¸ì„ :', routesToAdd.length + 'ê°œ (', displayedRoutesCount, 'ë¶€í„°', nextCount, 'ê¹Œì§€)');
        
        // ìƒˆë¡œìš´ ë…¸ì„  ì¹´ë“œë“¤ ì¶”ê°€
        routesToAdd.forEach(function(route) {
            var routeCard = document.createElement('div');
            routeCard.className = 'route-card';
            routeCard.innerHTML = 
                '<h5>ë…¸ì„  ' + route.route_no + 'ë²ˆ</h5>' +
                '<p><strong>ë…¸ì„  ID:</strong> ' + route.route_id + '</p>' +
                '<p><strong>ì •ê±°ì¥ ìˆ˜:</strong> ' + route.node_count + 'ê°œ</p>';
            routesGrid.appendChild(routeCard);
        });
        
        displayedRoutesCount = nextCount;
        displayedCountSpan.textContent = displayedRoutesCount;
        
        // ëª¨ë“  ë…¸ì„ ì„ í‘œì‹œí–ˆìœ¼ë©´ ë”ë³´ê¸° ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        if (displayedRoutesCount >= allRoutes.length) {
            loadMoreBtn.style.display = 'none';
            showMessage('ëª¨ë“  ' + allRoutes.length + 'ê°œ ë…¸ì„ ì„ í‘œì‹œí–ˆìŠµë‹ˆë‹¤!', 'success');
        } else {
            var remainingCount = allRoutes.length - displayedRoutesCount;
            loadMoreBtn.textContent = 'ë”ë³´ê¸° (' + remainingCount + 'ê°œ ë” ìˆìŒ)';
        }
    }
    
    function loadMap() {
        const mapContainer = document.getElementById('folium-map');
        const iframe = document.getElementById('map-iframe');
        
        if (iframe) {
            iframe.src = '/api/bus-map?' + new Date().getTime(); // ìºì‹œ ë°©ì§€
        } else {
            mapContainer.innerHTML = '<iframe id="map-iframe" class="map-iframe" src="/api/bus-map"></iframe>';
        }
        
        showMessage('ì§€ë„ë¥¼ ë¡œë“œí–ˆìŠµë‹ˆë‹¤.', 'success');
    }
    
    function regenerateMap() {
        const mapContainer = document.getElementById('folium-map');
        mapContainer.innerHTML = '<div class="loading"><h4>ì§€ë„ë¥¼ ì¬ìƒì„± ì¤‘ì…ë‹ˆë‹¤...</h4><p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p></div>';
        
        fetch('/api/regenerate-bus-map')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mapContainer.innerHTML = '<iframe id="map-iframe" class="map-iframe" src="/api/bus-map?' + new Date().getTime() + '"></iframe>';
                    showMessage(data.message, 'success');
                } else {
                    mapContainer.innerHTML = '<div class="error-message">ì§€ë„ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.error + '</div>';
                    showMessage('ì§€ë„ ì¬ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            })
            .catch(error => {
                console.error('ì§€ë„ ì¬ìƒì„± ì˜¤ë¥˜:', error);
                mapContainer.innerHTML = '<div class="error-message">ì§€ë„ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
                showMessage('ì§€ë„ ì¬ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            });
    }
    
    function refreshRoutesInfo() {
        var routesInfo = document.getElementById('routes-info');
        routesInfo.innerHTML = '<p>ë…¸ì„  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
        
        fetch('/api/routes-summary')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allRoutes = data.routes;
                    displayedRoutesCount = 12;
                    
                    var html = '<div class="routes-stats">' +
                               '<strong>ì´ ë…¸ì„  ìˆ˜:</strong> ' + data.total_routes + 'ê°œ | ' +
                               '<span id="displayed-count">12</span>ê°œ í‘œì‹œ ì¤‘' +
                               '</div>' +
                               '<div id="routes-grid" class="routes-grid">';
                    
                    var routesToShow = data.routes.slice(0, 12);
                    routesToShow.forEach(function(route) {
                        html += '<div class="route-card">' +
                                '<h5>ë…¸ì„  ' + route.route_no + 'ë²ˆ</h5>' +
                                '<p><strong>ë…¸ì„  ID:</strong> ' + route.route_id + '</p>' +
                                '<p><strong>ì •ê±°ì¥ ìˆ˜:</strong> ' + route.node_count + 'ê°œ</p>' +
                                '</div>';
                    });
                    
                    html += '</div>';
                    
                    if (data.routes.length > 12) {
                        var remainingCount = data.routes.length - 12;
                        html += '<div class="load-more-container">' +
                                '<button id="load-more-routes" class="load-more-btn">' +
                                'ë”ë³´ê¸° (' + remainingCount + 'ê°œ ë” ìˆìŒ)' +
                                '</button>' +
                                '</div>';
                    }
                    
                    routesInfo.innerHTML = html;
                    
                    showMessage('ë…¸ì„  ì •ë³´ë¥¼ ìƒˆë¡œê³ ì¹¨í–ˆìŠµë‹ˆë‹¤.', 'success');
                } else {
                    routesInfo.innerHTML = '<div class="error-message">ë…¸ì„  ì •ë³´ ë¡œë“œ ì‹¤íŒ¨: ' + data.error + '</div>';
                    showMessage('ë…¸ì„  ì •ë³´ ìƒˆë¡œê³ ì¹¨ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            })
            .catch(error => {
                console.error('ë…¸ì„  ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
                routesInfo.innerHTML = '<div class="error-message">ë…¸ì„  ì •ë³´ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
                showMessage('ë…¸ì„  ì •ë³´ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            });
    }
    
    function downloadMap() {
        const link = document.createElement('a');
        link.href = '/api/bus-map';
        link.download = 'bus_routes_map.html';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showMessage('ì§€ë„ íŒŒì¼ ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í–ˆìŠµë‹ˆë‹¤.', 'success');
    }
    
    function updateButtonState(activeButton) {
        document.querySelectorAll('.map-controls button').forEach(btn => {
            btn.classList.remove('active');
        });
        activeButton.classList.add('active');
    }
    
    function showMessage(message, type) {
        const messageDiv = document.createElement('div');
        messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
        messageDiv.innerHTML = '<strong>' + message + '</strong>';
        
        const container = document.querySelector('.container');
        const mapInfo = container.querySelector('.map-info');
        
        // ê¸°ì¡´ ë©”ì‹œì§€ ì œê±°
        const existingMessages = container.querySelectorAll('.success-message, .error-message');
        existingMessages.forEach(msg => {
            if (!msg.closest('.data-panel')) {
                msg.remove();
            }
        });
        
        mapInfo.appendChild(messageDiv);
        
        // 3ì´ˆ í›„ ë©”ì‹œì§€ ì œê±°
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.parentNode.removeChild(messageDiv);
            }
        }, 3000);
    }
</script>
{% endblock %}
